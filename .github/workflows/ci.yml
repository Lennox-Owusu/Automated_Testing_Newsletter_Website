name: CI - Selenium JUnit

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  tests:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # Optional: Show Chrome/Java versions for debugging
      - name: Show tool versions
        run: |
          google-chrome --version || true
          java -version
          mvn -v

      # Run tests in headless mode (your BaseTest reads -Dheadless=true)
      - name: Run tests (headless)
        run: mvn -B -Dheadless=true clean test
        env:
          HTTP_PROXY: ""
          HTTPS_PROXY: ""



      # Always upload reports, even on failure
      - name: Upload Surefire test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      # --- Notifications (failure only) ---

      - name: Slack notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="‚ùå *Build Failed ‚Äî Automated Tests Encountered Issues*\n
          ‚Ä¢ *Repository:* ${REPO}\n
          ‚Ä¢ *Branch:* ${BRANCH}\n
          ‚Ä¢ *Commit:* ${SHA}\n\n
          One or more automated tests did not complete successfully.\n
          This usually happens when the application behaves differently than expected.\n\n
          *Possible Causes Include:*\n
          ‚Ä¢ A page or element did not load in time\n
          ‚Ä¢ Invalid or unexpected test data\n
          ‚Ä¢ A recent change affected the user interface\n
          ‚Ä¢ A button, field, or message was not found during the test\n\n
          Please review the full CI logs to identify the exact step that failed.\n\n
          üëâ *View full CI details:* ${RUN_URL}"

          JSON_PAYLOAD=$(printf '{"text": "%s"}' "$TEXT")
          curl -s -X POST -H "Content-type: application/json" --data "$JSON_PAYLOAD" "$SLACK_WEBHOOK_URL"

          
      - name: Slack notify on success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="üéâ *Build Successful ‚Äî Automated Tests Passed*\n
          ‚Ä¢ *Repository:* ${REPO}\n
          ‚Ä¢ *Branch:* ${BRANCH}\n
          ‚Ä¢ *Commit:* ${SHA}\n\n
          All tests completed successfully, and the system behaved as expected.\n
          No issues were detected.\n\n
          üëâ *View detailed CI run:* ${RUN_URL}"

          JSON_PAYLOAD=$(printf '{"text": "%s"}' "$TEXT")
          curl -s -X POST -H "Content-type: application/json" --data "$JSON_PAYLOAD" "$SLACK_WEBHOOK_URL"

      - name: Email notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚ùå CI failed ‚Äî ${{ github.repository }} @ ${{ github.ref_name }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          secure: true
          html_body: |
            <h3>CI FAILED</h3>
            <p>Repository: ${{ github.repository }}</p>
            <p>Branch: ${{ github.ref_name }}</p>
            <p>Commit: ${{ github.sha }}</p>
            <p>Run: <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Run</a></p>

      - name: Summary
        if: always()
        run: |
            echo "### Selenium CI Summary" >> $GITHUB_STEP_SUMMARY
            echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
            echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        

      
