name: CI - Selenium JUnit

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  tests:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # Optional: Show Chrome/Java versions for debugging
      - name: Show tool versions
        run: |
          google-chrome --version || true
          java -version
          mvn -v

      # Run tests in headless mode (your BaseTest reads -Dheadless=true)
      - name: Run tests (headless)
        run: mvn -B -Dheadless=true clean test

      # Always upload reports, even on failure
      - name: Upload Surefire test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      # --- Notifications (failure only) ---

      - name: Slack notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="❌ CI failed on *${REPO}*
          Branch: ${BRANCH}
          Commit: ${SHA}
          Run: ${RUN_URL}"

          # Build JSON without jq to avoid YAML quoting issues
          JSON_PAYLOAD=$(printf '{"text": "%s"}' "$(printf '%s' "$TEXT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read())[1:-1])')")
          curl -s -X POST -H "Content-type: application/json" --data "$JSON_PAYLOAD" "$SLACK_WEBHOOK_URL"

      - name: Email notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "❌ CI failed — ${{ github.repository }} @ ${{ github.ref_name }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          secure: true
          content_type: text/html
          html_body: |
            <h3>CI FAILED</h3>
            <p><b>Repository:</b> ${{ github.repository }}</p>
            <p><b>Branch:</b> ${{ github.ref_name }}</p>
            <p><b>Commit:</b> ${{ github.sha }}</p>
            <p>View details: <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Workflow run</a></p>
