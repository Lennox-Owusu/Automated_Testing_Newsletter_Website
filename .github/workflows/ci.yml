name: CI - Selenium JUnit

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Show tool versions
        run: |
          google-chrome --version || true
          java -version
          mvn -v

      - name: Run tests (headless)
        run: mvn -B -Dheadless=true clean test
        continue-on-error: true
        env:
          HTTP_PROXY: ""
          HTTPS_PROXY: ""

      - name: Upload Surefire test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      - name: Summarize test results
        if: always()
        run: |
          python3 - <<'PY'
          import os, glob, xml.etree.ElementTree as ET

          path = "target/surefire-reports"
          files = glob.glob(os.path.join(path, "TEST-*.xml"))

          total = failures = errors = skipped = 0
          first_fail_class = first_fail_method = first_fail_msg = ""

          for f in files:
            try:
              root = ET.parse(f).getroot()

              total    += int(root.attrib.get("tests", "0"))
              failures += int(root.attrib.get("failures", "0"))
              errors   += int(root.attrib.get("errors", "0"))
              skipped  += int(root.attrib.get("skipped", "0"))

              # Only capture the FIRST failing test
              if not first_fail_class:
                for tc in root.iter("testcase"):
                  # Try direct failure
                  fe = None
                  for tag in ("failure", "error"):
                    node = tc.find(tag)
                    if node is not None:
                      fe = node
                      break

                  # Fallback: nested failure
                  if fe is None:
                    for node in tc.iter():
                      if node.tag in ("failure", "error"):
                        fe = node
                        break

                  if fe is not None:
                    first_fail_class  = tc.attrib.get("classname", "")
                    first_fail_method = tc.attrib.get("name", "")
                    first_fail_msg    = (fe.attrib.get("message") or fe.text or "").strip()
                    break
            except Exception:
              pass

          passed = max(total - failures - errors - skipped, 0)

          with open(os.environ["GITHUB_ENV"], "a") as env:
            env.write(f"TOTAL_TESTS={total}\n")
            env.write(f"PASSED_TESTS={passed}\n")
            env.write(f"FAILED_TESTS={failures}\n")
            env.write(f"ERRORED_TESTS={errors}\n")
            env.write(f"SKIPPED_TESTS={skipped}\n")
            env.write(f"FIRST_FAIL_CLASS={first_fail_class}\n")
            env.write(f"FIRST_FAIL_METHOD={first_fail_method}\n")
            env.write(f"FIRST_FAIL_MSG={first_fail_msg}\n")
          PY

      - name: Slack notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          FAIL_SECTION=""
          if [ -n "$FIRST_FAIL_CLASS" ] && [ -n "$FIRST_FAIL_METHOD" ]; then
            FAIL_SECTION="â€¢ *Failing Test:* $FIRST_FAIL_CLASS.$FIRST_FAIL_METHOD\n"
          fi

          ERROR_SECTION=""
          if [ -n "$FIRST_FAIL_MSG" ]; then
            ERROR_SECTION="â€¢ *Error Message:* $FIRST_FAIL_MSG\n"
          fi

          TEXT="âŒ *Build Failed â€” Automated Tests*\n\n\
          â€¢ *Repository:* ${REPO}\n\
          â€¢ *Branch:* ${BRANCH}\n\
          â€¢ *Commit:* ${SHA}\n\
          â€¢ *Results:* ${PASSED_TESTS}/${TOTAL_TESTS} passed, ${FAILED_TESTS} failed, ${ERRORED_TESTS} errors, ${SKIPPED_TESTS} skipped\n\n\
          ${FAIL_SECTION}${ERROR_SECTION}\
          Please review the CI logs for more details.\n\n\
          ðŸ‘‰ *View run:* ${RUN_URL}"

          JSON_PAYLOAD=$(printf "%s" "$TEXT" | jq -Rs '{text: .}')
          curl -s -X POST -H "Content-type: application/json" \
            --data "$JSON_PAYLOAD" "$SLACK_WEBHOOK_URL"

      - name: Slack notify on success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="ðŸŽ‰ *Build Successful â€” Automated Tests Passed*\n\n\
          â€¢ *Repository:* ${REPO}\n\
          â€¢ *Branch:* ${BRANCH}\n\
          â€¢ *Commit:* ${SHA}\n\
          â€¢ *Results:* ${PASSED_TESTS}/${TOTAL_TESTS} passed, ${SKIPPED_TESTS} skipped\n\n\
          ðŸ‘‰ *View run:* ${RUN_URL}"

          JSON_PAYLOAD=$(printf "%s" "$TEXT" | jq -Rs '{text: .}')
          curl -s -X POST -H "Content-type: application/json" \
            --data "$JSON_PAYLOAD" "$SLACK_WEBHOOK_URL"

      - name: Email notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          secure: true
          subject: "âŒ CI failed â€” ${{ github.repository }} @ ${{ github.ref_name }}"
          content_type: text/html
          html_body: |
            <h3>CI FAILED</h3>
            <p><b>Repository:</b> ${{ github.repository }}</p>
            <p><b>Branch:</b> ${{ github.ref_name }}</p>
            <p><b>Commit:</b> ${{ github.sha }}</p>
            <p><b>Results:</b> ${{ env.PASSED_TESTS }}/${{ env.TOTAL_TESTS }} passed</p>
            <p><b>Failing Test:</b> ${{ env.FIRST_FAIL_CLASS }}.${{ env.FIRST_FAIL_METHOD }}</p>
            <p><b>Error Message:</b> ${{ env.FIRST_FAIL_MSG }}</p>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Run</a></p>

      - name: Summary
        if: always()
        run: |
          echo "### Selenium CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Total tests: ${TOTAL_TESTS}" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: ${PASSED_TESTS}" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: ${FAILED_TESTS}" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: ${ERRORED_TESTS}" >> $GITHUB_STEP_SUMMARY
          echo "- Skipped: ${SKIPPED_TESTS}" >> $GITHUB_STEP_SUMMARY
          if [ -n "$FIRST_FAIL_CLASS" ]; then
            echo "- First failing test: $FIRST_FAIL_CLASS.$FIRST_FAIL_METHOD" >> $GITHUB_STEP_SUMMARY
            echo "- Error: $FIRST_FAIL_MSG" >> $GITHUB_STEP_SUMMARY
          fi
