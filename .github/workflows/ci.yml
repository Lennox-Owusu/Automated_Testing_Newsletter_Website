name: CI - Selenium JUnit

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  tests:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Show tool versions
        run: |
          google-chrome --version || true
          java -version
          mvn -v

      - name: Run tests (headless)
        run: mvn -B -Dheadless=true clean test
        env:
          HTTP_PROXY: ""
          HTTPS_PROXY: ""

      - name: Upload Surefire test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      - name: Summarize test results
        if: always()
        run: |
          python3 - << 'PY'
          import os, glob, xml.etree.ElementTree as ET

          report_dir = "target/surefire-reports"
          files = glob.glob(os.path.join(report_dir, "TEST-*.xml"))

          total = failures = errors = skipped = 0
          first_fail_class = first_fail_method = first_fail_msg = ""

          print("ðŸ“Œ DEBUG: Found XML files:", files)

          for f in files:
              try:
                  print("ðŸ“Œ DEBUG: Parsing:", f)
                  root = ET.parse(f).getroot()

                  total    += int(root.attrib.get("tests", "0"))
                  failures += int(root.attrib.get("failures", "0"))
                  errors   += int(root.attrib.get("errors", "0"))
                  skipped  += int(root.attrib.get("skipped", "0"))

                  if not first_fail_class:
                      for tc in root.iter("testcase"):
                          fe = None
                          for tag in ("failure", "error"):
                              node = tc.find(tag)
                              if node is not None:
                                  fe = node
                                  break

                          if fe is None:
                              for node in tc.iter():
                                  if node.tag in ("failure", "error"):
                                      fe = node
                                      break

                          if fe is not None:
                              first_fail_class  = tc.attrib.get("classname", "")
                              first_fail_method = tc.attrib.get("name", "")
                              raw_msg = fe.attrib.get("message")
                              first_fail_msg = (raw_msg.strip() if raw_msg else "".join(fe.itertext()).strip()) or "No failure message"
                              break
              except Exception as e:
                  print("âš ï¸ DEBUG: Parser error:", e)

          passed = max(total - failures - errors - skipped, 0)

          with open(os.environ["GITHUB_ENV"], "a") as env:
              env.write(f"TOTAL_TESTS={total}\n")
              env.write(f"PASSED_TESTS={passed}\n")
              env.write(f"FAILED_TESTS={failures}\n")
              env.write(f"ERRORED_TESTS={errors}\n")
              env.write(f"SKIPPED_TESTS={skipped}\n")
              env.write(f"FIRST_FAIL_CLASS={first_fail_class}\n")
              env.write(f"FIRST_FAIL_METHOD={first_fail_method}\n")
              env.write(f"FIRST_FAIL_MSG={first_fail_msg}\n")
          PY

      - name: Slack notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA:    ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          PAYLOAD=$(
            jq -n \
              --arg repo "$REPO" \
              --arg branch "$BRANCH" \
              --arg sha "$SHA" \
              --arg run "$RUN_URL" \
              --arg passed "$PASSED_TESTS" \
              --arg total "$TOTAL_TESTS" \
              --arg failed "$FAILED_TESTS" \
              --arg errs "$ERRORED_TESTS" \
              --arg skipped "$SKIPPED_TESTS" \
              --arg fclass "$FIRST_FAIL_CLASS" \
              --arg fmethod "$FIRST_FAIL_METHOD" \
              --arg fmsg "$FIRST_FAIL_MSG" \
              '{
                 text: "CI Failed â€” Automated Tests",
                 blocks: [
                   { "type":"header", "text": { "type":"plain_text", "text":"âŒ CI Failed â€” Automated Tests" } },
                   { "type":"section",
                     "fields": [
                       { "type":"mrkdwn", "text": ("*Repository:*\n" + $repo) },
                       { "type":"mrkdwn", "text": ("*Branch:*\n" + $branch) },
                       { "type":"mrkdwn", "text": ("*Commit:*\n" + $sha) },
                       { "type":"mrkdwn", "text": ("*Results:*\n" + $passed + "/" + $total + " passed, " + $failed + " failed, " + $errs + " errors, " + $skipped + " skipped") }
                     ]},
                   { "type":"section",
                     "fields": [
                       { "type":"mrkdwn", "text": ("*Failing Test:*\n" + $fclass + "." + $fmethod) },
                       { "type":"mrkdwn", "text": ("*Error:*\n" + $fmsg) }
                     ]},
                   { "type":"actions",
                     "elements": [
                       { "type":"button", "text": { "type":"plain_text", "text":"View CI Run" }, "url": $run, "style":"danger" }
                     ]}
                 ]
               }'
          )

          curl -s -X POST -H "Content-type: application/json" \
            --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" -w "\nHTTP %{http_code}\n"

      - name: Slack notify on success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA:    ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          PAYLOAD=$(
            jq -n \
              --arg repo "$REPO" \
              --arg branch "$BRANCH" \
              --arg sha "$SHA" \
              --arg run "$RUN_URL" \
              --arg passed "$PASSED_TESTS" \
              --arg total "$TOTAL_TESTS" \
              --arg skipped "$SKIPPED_TESTS" \
              '{
                 text: "CI Passed â€” Automated Tests",
                 blocks: [
                   { "type":"header", "text": { "type":"plain_text", "text":"âœ… CI Passed â€” Automated Tests" } },
                   { "type":"section",
                     "fields": [
                       { "type":"mrkdwn", "text": ("*Repository:*\n" + $repo) },
                       { "type":"mrkdwn", "text": ("*Branch:*\n" + $branch) },
                       { "type":"mrkdwn", "text": ("*Commit:*\n" + $sha) },
                       { "type":"mrkdwn", "text": ("*Results:*\n" + $passed + "/" + $total + " passed, " + $skipped + " skipped") }
                     ]},
                   { "type":"actions",
                     "elements": [
                       { "type":"button", "text": { "type":"plain_text", "text":"View CI Run" }, "url": $run, "style":"primary" }
                     ]}
                 ]
               }'
          )

          curl -s -X POST -H "Content-type: application/json" \
            --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" -w "\nHTTP %{http_code}\n"

      # -----------------------
      # FIXED HTML EMAIL + DEBUG
      # -----------------------

      - name: Prepare email body (success)
        if: success()
        id: email_body_ok
        run: |
          cat > ok_email.html <<HTML
          <div style="font-family:Arial,Helvetica,sans-serif;max-width:680px;margin:0 auto;">
          <h2>âœ… CI Passed â€” Automated Tests</h2>
          <p>All automated checks completed successfully.</p>

          <table style="border-collapse:collapse;width:100%;border:1px solid #eee;font-size:14px;">
          <tr><td><b>Repository</b></td><td>$GITHUB_REPOSITORY</td></tr>
          <tr><td><b>Branch</b></td><td>$GITHUB_REF_NAME</td></tr>
          <tr><td><b>Commit</b></td><td>$GITHUB_SHA</td></tr>
          <tr><td><b>Results</b></td><td>$PASSED_TESTS/$TOTAL_TESTS passed, $SKIPPED_TESTS skipped</td></tr>
          </table>

       <p style="margin-top: 14px;">
         <a href="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
         style="background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:6px;text-decoration:none;">
         View CI Run
         </a>
         </p>
         </div>
         HTML

          {
            echo "html<<EOF"
            cat ok_email.html
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Debug email body and envs
        if: success()
        run: |
          echo "----- HTML Preview -----"
          sed -n '1,120p' ok_email.html || true
          echo ""
          echo "----- File size -----"
          wc -c ok_email.html || true
          echo ""
          echo "--- ENV VARS ---"
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo "GITHUB_REF_NAME=$GITHUB_REF_NAME"
          echo "GITHUB_SHA=$GITHUB_SHA"
          echo "PASSED_TESTS=$PASSED_TESTS"
          echo "TOTAL_TESTS=$TOTAL_TESTS"
          echo "SKIPPED_TESTS=$SKIPPED_TESTS"

      - name: Email notify on success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.SMTP_USERNAME }}
          to: ${{ secrets.MAIL_TO }}
          subject: "âœ… CI passed â€” ${{ github.repository }} @ ${{ github.ref_name }}"
          html_body: ${{ steps.email_body_ok.outputs.html }}

      - name: Summary
        if: always()
        run: |
          {
            echo "## ðŸš€ Selenium CI Summary"
            echo "**Status:** \`${{ job.status }}\`"
            echo "**Branch:** ${{ github.ref_name }}"
            echo "**Commit:** ${{ github.sha }}"
            echo ""
            echo "### ðŸ§ª Test Results"
            echo "- Total tests: ${TOTAL_TESTS}"
            echo "- Passed: ${PASSED_TESTS}"
            echo "- Failed: ${FAILED_TESTS}"
            echo "- Errors: ${ERRORED_TESTS}"
            echo "- Skipped: ${SKIPPED_TESTS}"
            echo ""
            if [ -n "$FIRST_FAIL_CLASS" ]; then
              echo "### âŒ First Failing Test"
              echo "- **Test:** \`${FIRST_FAIL_CLASS}.${FIRST_FAIL_METHOD}\`"
              echo "- **Error:** \`${FIRST_FAIL_MSG}\`"
            fi
          } >> $GITHUB_STEP_SUMMARY
