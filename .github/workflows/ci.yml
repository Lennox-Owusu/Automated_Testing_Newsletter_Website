name: CI - Selenium JUnit

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  tests:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # Optional: Show Chrome/Java versions for debugging
      - name: Show tool versions
        run: |
          google-chrome --version || true
          java -version
          mvn -v

      # Run tests in headless mode (your BaseTest reads -Dheadless=true)
      - name: Run tests (headless)
        run: mvn -B -Dheadless=true clean test
        env:
          HTTP_PROXY: ""
          HTTPS_PROXY: ""



      # Always upload reports, even on failure
      - name: Upload Surefire test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

      - name: Summarize test results
        if: always()
        run: |
          python3 - << 'PY'
          import os, glob, xml.etree.ElementTree as ET

          report_dir = "target/surefire-reports"
          files = glob.glob(os.path.join(report_dir, "TEST-*.xml"))

          total = failures = errors = skipped = 0
          first_fail_class = first_fail_method = first_fail_msg = ""

          print("üìå DEBUG: Found XML files:", files)

          for f in files:
              try:
                  print("üìå DEBUG: Parsing:", f)
                  root = ET.parse(f).getroot()

                  total    += int(root.attrib.get("tests", "0"))
                  failures += int(root.attrib.get("failures", "0"))
                  errors   += int(root.attrib.get("errors", "0"))
                  skipped  += int(root.attrib.get("skipped", "0"))

                  if not first_fail_class:
                      for tc in root.iter("testcase"):
                          fe = None

                          # direct failure/error
                          for tag in ("failure", "error"):
                              node = tc.find(tag)
                              if node is not None:
                                  fe = node
                                  break

                          # nested failure/error
                          if fe is None:
                              for node in tc.iter():
                                  if node.tag in ("failure", "error"):
                                      fe = node
                                      break

                          if fe is not None:
                              first_fail_class  = tc.attrib.get("classname", "")
                              first_fail_method = tc.attrib.get("name", "")

                              raw_msg = fe.attrib.get("message")
                              if raw_msg and raw_msg.strip():
                                  first_fail_msg = raw_msg.strip()
                              else:
                                  # CDATA extraction
                                  cdata = "".join(fe.itertext()).strip()
                                  first_fail_msg = cdata if cdata else "No failure message"

                              break

              except Exception as e:
                  print("‚ö†Ô∏è DEBUG: Parser error:", e)

          passed = max(total - failures - errors - skipped, 0)

          print("üìå DEBUG SUMMARY")
          print("TOTAL:", total)
          print("PASSED:", passed)
          print("FAILED:", failures)
          print("ERRORS:", errors)
          print("SKIPPED:", skipped)
          print("FAIL CLASS:", first_fail_class)
          print("FAIL METHOD:", first_fail_method)
          print("FAIL MSG:", first_fail_msg)

          with open(os.environ["GITHUB_ENV"], "a") as env:
              env.write(f"TOTAL_TESTS={total}\n")
              env.write(f"PASSED_TESTS={passed}\n")
              env.write(f"FAILED_TESTS={failures}\n")
              env.write(f"ERRORED_TESTS={errors}\n")
              env.write(f"SKIPPED_TESTS={skipped}\n")
              env.write(f"FIRST_FAIL_CLASS={first_fail_class}\n")
              env.write(f"FIRST_FAIL_METHOD={first_fail_method}\n")
              env.write(f"FIRST_FAIL_MSG={first_fail_msg}\n")
          PY
      # --- Notifications (failure only) ---

      - name: Slack notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA:    ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Ensure jq exists (usually present on ubuntu-latest)
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          echo "DEBUG FAIL CLASS: $FIRST_FAIL_CLASS"
          echo "DEBUG FAIL METHOD: $FIRST_FAIL_METHOD"
          echo "DEBUG FAIL MSG: $FIRST_FAIL_MSG"

          # Build JSON safely with jq (handles quotes/newlines)
          PAYLOAD=$(
            jq -n \
              --arg repo    "$REPO" \
              --arg branch  "$BRANCH" \
              --arg sha     "$SHA" \
              --arg run     "$RUN_URL" \
              --arg passed  "$PASSED_TESTS" \
              --arg total   "$TOTAL_TESTS" \
              --arg failed  "$FAILED_TESTS" \
              --arg errs    "$ERRORED_TESTS" \
              --arg skipped "$SKIPPED_TESTS" \
              --arg fclass  "$FIRST_FAIL_CLASS" \
              --arg fmethod "$FIRST_FAIL_METHOD" \
              --arg fmsg    "$FIRST_FAIL_MSG" \
              '{
                 text: "CI Failed ‚Äî Automated Tests",
                 blocks: [
                   { "type":"header",
                     "text": { "type":"plain_text", "text":"‚ùå CI Failed ‚Äî Automated Tests" } },
                   { "type":"section",
                     "fields": [
                       { "type":"mrkdwn", "text": ("*Repository:*\n" + $repo) },
                       { "type":"mrkdwn", "text": ("*Branch:*\n" + $branch) },
                       { "type":"mrkdwn", "text": ("*Commit:*\n" + $sha) },
                       { "type":"mrkdwn", "text": ("*Results:*\n" + $passed + "/" + $total + " passed, " + $failed + " failed, " + $errs + " errors, " + $skipped + " skipped") }
                     ]},
                   { "type":"section",
                     "fields": [
                       { "type":"mrkdwn", "text": ("*Failing Test:*\n" + $fclass + "." + $fmethod) },
                       { "type":"mrkdwn", "text": ("*Error:*\n" + $fmsg) }
                     ]},
                   { "type":"actions",
                     "elements": [
                       { "type":"button",
                         "text": { "type":"plain_text", "text":"View CI Run" },
                         "url": $run, "style":"danger" }
                     ]}
                 ]
               }'
          )

          # Send and print HTTP status for quick debugging
          curl -s -X POST -H "Content-type: application/json" \
            --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" -w "\nHTTP %{http_code}\n"
          
      - name: Slack notify on success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA:    ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          PAYLOAD=$(
            jq -n \
              --arg repo    "$REPO" \
              --arg branch  "$BRANCH" \
              --arg sha     "$SHA" \
              --arg run     "$RUN_URL" \
              --arg passed  "$PASSED_TESTS" \
              --arg total   "$TOTAL_TESTS" \
              --arg skipped "$SKIPPED_TESTS" \
              '{
                 text: "CI Passed ‚Äî Automated Tests",
                 blocks: [
                   { "type":"header",
                     "text": { "type":"plain_text", "text":"‚úÖ CI Passed ‚Äî Automated Tests" } },
                   { "type":"section",
                     "fields": [
                       { "type":"mrkdwn", "text": ("*Repository:*\n" + $repo) },
                       { "type":"mrkdwn", "text": ("*Branch:*\n" + $branch) },
                       { "type":"mrkdwn", "text": ("*Commit:*\n" + $sha) },
                       { "type":"mrkdwn", "text": ("*Results:*\n" + $passed + "/" + $total + " passed, " + $skipped + " skipped") }
                     ]},
                   { "type":"actions",
                     "elements": [
                       { "type":"button",
                         "text": { "type":"plain_text", "text":"View CI Run" },
                         "url": $run, "style":"primary" }
                     ]}
                 ]
               }'
          )

          curl -s -X POST -H "Content-type: application/json" \
            --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" -w "\nHTTP %{http_code}\n"

      - name: Prepare email body (success)
        if: success()
        id: email_body_ok
        run: |
          cat > ok_email.html <<HTML_EOF
          <div style="font-family:Arial,Helvetica,sans-serif;max-width:680px;margin:0 auto;">
          <h2 style="margin:0 0 12px 0;">‚úÖ CI Passed ‚Äî Automated Tests</h2>
          <p style="color:#444;margin:0 0 16px 0;">
          All automated checks completed successfully.
          </p>

          <table role="presentation" cellspacing="0" cellpadding="6" style="border-collapse:collapse;width:100%;border:1px solid #eee;font-size:14px;">
          <tr><td style="background:#fafafa;width:180px;"><b>Repository</b></td><td>${GITHUB_REPOSITORY}</td></tr>
          <tr><td style="background:#fafafa;"><b>Branch</b></td><td>${GITHUB_REF_NAME}</td></tr>
          <tr><td style="background:#fafafa;"><b>Commit</b></td><td>${GITHUB_SHA}</td></tr>
          <tr><td style="background:#fafafa;"><b>Results</b></td><td>${PASSED_TESTS}/${TOTAL_TESTS} passed, ${SKIPPED_TESTS} skipped</td></tr>
          </table>

          <p style="margin:16px 0 0 0;">
          <a href="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          style="display:inline-block;background:#0ea5e9;color:#fff;text-decoration:none;padding:10px 14px;border-radius:6px;">
          View CI Run
          </a>
          </p>
          </div>
          HTML_EOF

          {
            echo "html<<EOF"
            cat ok_email.html
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Email notify on success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}   # your full Gmail address
          password: ${{ secrets.SMTP_PASSWORD }}   # Gmail App Password
          from: ${{ secrets.SMTP_USERNAME }}        # must match Gmail account
          to: ${{ secrets.MAIL_TO }}
          subject: "‚úÖ CI passed ‚Äî ${{ github.repository }} @ ${{ github.ref_name }}"
          html_body: ${{ steps.email_body_ok.outputs.html }}

      - name: Prepare email body (failure)
        if: failure()
        id: email_body_fail
        run: |
          # Provide safe defaults if parsing step didn't set them
          : "${TOTAL_TESTS:=0}"
          : "${PASSED_TESTS:=0}"
          : "${FAILED_TESTS:=0}"
          : "${ERRORED_TESTS:=0}"
          : "${SKIPPED_TESTS:=0}"
          : "${FIRST_FAIL_CLASS:=N/A}"
          : "${FIRST_FAIL_METHOD:=N/A}"
          : "${FIRST_FAIL_MSG:=No failure message captured}"

          cat > fail_email.html <<HTML_EOF
          <div style="font-family:Arial,Helvetica,sans-serif;max-width:680px;margin:0 auto;">
            <h2 style="margin:0 0 12px 0;color:#b91c1c;">‚ùå CI Failed ‚Äî Automated Tests</h2>
            <p style="color:#444;margin:0 0 16px 0;">
              One or more automated checks failed for this run.
            </p>

            <table role="presentation" cellspacing="0" cellpadding="6"
                   style="border-collapse:collapse;width:100%;border:1px solid #eee;font-size:14px;">
              <tr><td style="background:#fafafa;width:180px;"><b>Repository</b></td><td>${GITHUB_REPOSITORY}</td></tr>
              <tr><td style="background:#fafafa;"><b>Branch</b></td><td>${GITHUB_REF_NAME}</td></tr>
              <tr><td style="background:#fafafa;"><b>Commit</b></td><td>${GITHUB_SHA}</td></tr>
              <tr><td style="background:#fafafa;"><b>Results</b></td>
                  <td>${PASSED_TESTS}/${TOTAL_TESTS} passed,
                      ${FAILED_TESTS} failed, ${ERRORED_TESTS} errors, ${SKIPPED_TESTS} skipped</td></tr>
              <tr><td style="background:#fafafa;"><b>Failing Test</b></td>
                  <td>${FIRST_FAIL_CLASS}.${FIRST_FAIL_METHOD}</td></tr>
              <tr><td style="background:#fafafa;"><b>Error</b></td>
                  <td><pre style="white-space:pre-wrap;font-family:Menlo,Consolas,monospace;">${FIRST_FAIL_MSG}</pre></td></tr>
            </table>

            <p style="margin:16px 0 0 0;">
              <a href="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
                 style="display:inline-block;background:#ef4444;color:#fff;text-decoration:none;padding:10px 14px;border-radius:6px;">
                View CI Run
              </a>
            </p>
          </div>
          HTML_EOF

          {
            echo "html<<EOF"
            cat fail_email.html
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Email notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}   # your full Gmail address
          password: ${{ secrets.SMTP_PASSWORD }}   # Gmail App Password
          from: ${{ secrets.SMTP_USERNAME }}        # must match Gmail account
          to: ${{ secrets.MAIL_TO }}
          subject: "‚ùå CI failed ‚Äî ${{
            github.repository
            }} @ ${{
                github.ref_name
            }}"
          html_body: ${{ steps.email_body_fail.outputs.html }}
          

      - name: Summary
        if: always()
        run: |
          {
            echo "## üöÄ Selenium CI Summary"
            echo ""
            echo "**Status:** \`${{ job.status }}\`"
            echo "**Branch:** ${{ github.ref_name }}"
            echo "**Commit:** ${{ github.sha }}"
            echo ""
            echo "### üß™ Test Results"
            echo "- Total tests: ${TOTAL_TESTS}"
            echo "- Passed: ${PASSED_TESTS}"
            echo "- Failed: ${FAILED_TESTS}"
            echo "- Errors: ${ERRORED_TESTS}"
            echo "- Skipped: ${SKIPPED_TESTS}"
            echo ""

            if [ -n "$FIRST_FAIL_CLASS" ]; then
              echo "### ‚ùå First Failing Test"
              echo "- **Test:** \`${FIRST_FAIL_CLASS}.${FIRST_FAIL_METHOD}\`"
              echo "- **Error:** \`${FIRST_FAIL_MSG}\`"
              echo ""
            fi

            echo "### üîó CI Run Link"
            echo "[Click here to view this workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> $GITHUB_STEP_SUMMARY



