name: CI - Selenium JUnit

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Install Chrome (safe)
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable || true
          google-chrome --version || true

      - name: Show tool versions
        run: |
          java -version
          mvn -v

      # Run tests in headless mode (resilient)
      - name: Run tests (headless)
        run: mvn -B -Dheadless=true -Dmaven.test.failure.ignore=true clean test
        continue-on-error: true
        env:
          HTTP_PROXY: ""
          HTTPS_PROXY: ""

      - name: Upload Surefire test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports
          if-no-files-found: warn

      - name: Summarize test results
        if: always()
        run: |
          python3 - <<'PY'
          import os, glob, xml.etree.ElementTree as ET

          report_dir = "target/surefire-reports"
          files = glob.glob(os.path.join(report_dir, "TEST-*.xml"))

          total = failures = errors = skipped = 0
          first_fail_class = first_fail_method = first_fail_msg = ""

          for f in files:
            try:
              tree = ET.parse(f)
              root = tree.getroot()
              total     += int(root.attrib.get("tests", "0"))
              failures  += int(root.attrib.get("failures", "0"))
              errors    += int(root.attrib.get("errors", "0"))
              skipped   += int(root.attrib.get("skipped", "0"))

              if not first_fail_class:
                for tc in root.iter("testcase"):
                  fe = tc.find("failure") or tc.find("error")
                  if fe is not None:
                    first_fail_class  = tc.attrib.get("classname","")
                    first_fail_method = tc.attrib.get("name","")
                    first_fail_msg = (fe.attrib.get("message") or (fe.text or "")).strip()
                    if len(first_fail_msg) > 300:
                      first_fail_msg = first_fail_msg[:300] + "‚Ä¶"
                    break
            except Exception:
              pass

          passed = max(total - failures - errors - skipped, 0)

          with open(os.environ["GITHUB_ENV"], "a") as env:
            env.write(f"TOTAL_TESTS={total}\n")
            env.write(f"PASSED_TESTS={passed}\n")
            env.write(f"FAILED_TESTS={failures}\n")
            env.write(f"ERRORED_TESTS={errors}\n")
            env.write(f"SKIPPED_TESTS={skipped}\n")
            env.write(f"FIRST_FAIL_CLASS={first_fail_class}\n")
            env.write(f"FIRST_FAIL_METHOD={first_fail_method}\n")
            env.write(f"FIRST_FAIL_MSG={first_fail_msg}\n")
          PY

      # --- Slack notifications ---

      # IMPORTANT: Do NOT try to re-map FIRST_FAIL_* via ${{ env.* }}
      # They are available at runtime already (written to GITHUB_ENV above).

      - name: Slack notify on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA:    ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          FAIL_SECTION=""
          if [ -n "${FIRST_FAIL_CLASS}${FIRST_FAIL_METHOD}" ]; then
            FAIL_SECTION="‚Ä¢ *Failing Test:* ${FIRST_FAIL_CLASS}.${FIRST_FAIL_METHOD}\n"
          fi

          ERROR_SECTION=""
          if [ -n "${FIRST_FAIL_MSG}" ]; then
            ERROR_SECTION="‚Ä¢ *Error Message:* ${FIRST_FAIL_MSG}\n"
          fi

          TEXT="‚ùå *Build Failed ‚Äî Automated Tests*\n
          ‚Ä¢ *Repository:* ${REPO}\n
          ‚Ä¢ *Branch:* ${BRANCH}\n
          ‚Ä¢ *Commit:* ${SHA}\n
          ‚Ä¢ *Results:* ${PASSED_TESTS}/${TOTAL_TESTS} passed,\n  ${FAILED_TESTS} failed, ${ERRORED_TESTS} errors, ${SKIPPED_TESTS} skipped\n
          ${FAIL_SECTION}${ERROR_SECTION}\n
          Please review the CI logs for more details.\n\n
          üëâ *View run:* ${RUN_URL}"

          JSON_PAYLOAD=$(printf '{"text": "%s"}' "$TEXT")
          curl -s -X POST -H "Content-type: application/json" \
            --data "$JSON_PAYLOAD" "$SLACK_WEBHOOK_URL"

      - name: Slack notify on success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA:    ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="üéâ *Build Successful ‚Äî Automated Tests Passed*\n
          ‚Ä¢ *Repository:* ${REPO}\n
          ‚Ä¢ *Branch:* ${BRANCH}\n
          ‚Ä¢ *Commit:* ${SHA}\n
          ‚Ä¢ *Results:* ${PASSED_TESTS}/${TOTAL_TESTS} passed, ${SKIPPED_TESTS} skipped\n\n
          All checks completed successfully.\n\n
          üëâ *View run:* ${RUN_URL}"

          JSON_PAYLOAD=$(printf '{"text": "%s"}' "$TEXT")
          curl -s -X POST -H "Content-type: application/json" --data "$JSON_PAYLOAD" "$SLACK_WEBHOOK_URL"

      # --- Email (failure only) ---
      # Tip: Use SMTP_HOST=smtp.gmail.com, SMTP_PORT=465, and an App Password if using Gmail.
      # Ensure MAIL_FROM equals SMTP_USERNAME to avoid "Sender address rejected".
      - name: Email notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: true
          subject: "‚ùå CI failed ‚Äî ${{ github.repository }} @ ${{ github.ref_name }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.SMTP_USERNAME }}
          content_type: text/html
          html_body: |
            <h3>CI FAILED</h3>
            <p><b>Repository:</b> ${{ github.repository }}</p>
            <p><b>Branch:</b> ${{ github.ref_name }}</p>
            <p><b>Commit:</b> ${{ github.sha }}</p>
            <p><b>Results:</b> ${{ env.PASSED_TESTS }}/${{ env.TOTAL_TESTS }} passed,
            ${{ env.FAILED_TESTS }} failed, ${{ env.ERRORED_TESTS }} errors, ${{ env.SKIPPED_TESTS }} skipped</p>
            <p><b>Failing Test:</b> ${{ env.FIRST_FAIL_CLASS }}.${{ env.FIRST_FAIL_METHOD }}</p>
            <p><b>Error Message:</b> ${{ env.FIRST_FAIL_MSG }}</p>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Run</a></p>

      # Pretty Job Summary on the run page
      - name: Summary
        if: always()
        run: |
          echo "### Selenium CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Results: ${PASSED_TESTS}/${TOTAL_TESTS} passed, ${FAILED_TESTS} failed, ${ERRORED_TESTS} errors, ${SKIPPED_TESTS} skipped" >> $GITHUB_STEP_SUMMARY
          if [ -n "${FIRST_FAIL_CLASS}${FIRST_FAIL_METHOD}" ]; then
            echo "- First failing test: ${FIRST_FAIL_CLASS}.${FIRST_FAIL_METHOD}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${FIRST_FAIL_MSG}" ]; then
            echo "- Error: ${FIRST_FAIL_MSG}" >> $GITHUB_STEP_SUMMARY
          fi
